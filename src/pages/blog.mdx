import Link from "next/link"
import { getPagesUnderRoute } from "nextra/context"
import { Tag, Card } from "@/components"
import NextLink from "next/link"
import { useRouter } from "next/router"
import { clsx } from "clsx"

export default function Blog() {
  const { asPath } = useRouter()
  const items = getPagesUnderRoute("/blog").flatMap(
    item => item.children || item
  )
  const blogs = items.sort((a, b) => b.frontMatter.date - a.frontMatter.date)
  const currentTag = asPath.startsWith("/blog")
    ? ""
    : asPath.replace("/tags/", "").replace(/\/$/, "")
  //
  const tags = blogs
    .flatMap(blog => blog.frontMatter.tags)
    .reduce((acc, tag) => {
      acc[tag] ||= 0
      acc[tag] += 1
      return acc
    }, {})
  //
  const tagList = (
    <div className="roboto-mono mt-6 flex flex-wrap gap-3 md:gap-5">
      {Object.entries(tags)
        .sort((a, b) => b[1] - a[1])
        .map(([tag, count]) => (
          <NextLink
            key={tag}
            href={currentTag === tag ? "/blog" : `/tags/${tag}`}
            data-active={currentTag === tag ? "" : undefined}
            className={clsx("tag capitalize [&[data-active]]:bg-primary")}
          >
            {tag.replaceAll("-", " ")} ({count})
          </NextLink>
        ))}
    </div>
  )
  //
  const blogList = blogs.map(
    page =>
      (!currentTag || page.frontMatter.tags.includes(currentTag)) && (
        <Card
          key={page.route}
          as={Link}
          href={page.route}
          className="flex flex-col"
        >
          <div className="mb-7 flex gap-2">
            {page.frontMatter.tags.map(tag => (
              <Tag key={tag}>{tag.replaceAll("-", " ")}</Tag>
            ))}
          </div>
          <div className="text-balance text-xl font-extrabold md:text-3xl">
            {page.frontMatter.title}
          </div>
          <div className="my-7 flex gap-2 text-sm opacity-50">
            <time dateTime={page.frontMatter.date.toISOString()}>
              {page.frontMatter.date.toLocaleDateString("en", {
                month: "long",
                day: "numeric",
                year: "numeric"
              })}
            </time>
            <span className="border-r border-gray-500" />
            <span>by {page.frontMatter.byline}</span>
          </div>
          <span className="mt-auto block font-bold text-primary">
            Read more â†’
          </span>
        </Card>
      )
  )
  return (
    <>
      <div className="container py-10 md:py-20">
        <h1 className="mb-10 text-4xl font-extrabold md:text-7xl">Blog</h1>
        <h3 className="text-2xl font-bold">Categories</h3>
        {tagList}
      </div>
      <div className="container grid gap-7 pb-10 md:grid-cols-2">
        {blogList}
      </div>
    </>
  )
}
